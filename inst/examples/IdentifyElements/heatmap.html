<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Finding SVG Nodes for a heatmap() Plot in R</title><link rel="stylesheet" type="text/css" href="../OmegaTech.css"></link><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"></meta><script xmlns="" type="text/javascript" src="http://www.omegahat.org/DynDocs/JavaScript/toggleHidden.js"></script>
</head><body class="yui-skin-sam">
<script xmlns="" type="text/javascript"><!--
var toggleCodeIds = [
 
   "idp6484576", 
   "idp6486192", 
   "idp6486928", 
   "idp6488080", 
   "idp6489872", 
   "idp6490256", 
   "idp6492752", 
   "idp6493904", 
   "idp6495056", 
   "idp6498240", 
   "idp6499856", 
   "idp6502544", 
   "idp6507264", 
   "idp6508336", 
   "idp6508864", 
   "idp6509312", 
   "idp6513520", 
   "idp6514864", 
   "idp6515856", 
   "idp6516688", 
   "idp6517856", 
   "idp6518416", 
   "idp6519744", 
   "idp6520304", 
   "idp6523840"
];
--></script><p xmlns=""></p>
<div class="article" title="Finding SVG Nodes for a heatmap() Plot in R"><div class="titlepage"><div><div><h2 class="title"><a id="idm22777600"></a>Finding SVG Nodes for a <i xmlns="" class="rfunc"><a href="Help//heatmap.html" title="">heatmap()</a></i> Plot in R</h2></div><div><div class="author"><h3 class="author"><span class="firstname">Duncan</span> <span class="surname">Temple Lang</span></h3><div class="affiliation"><span class="orgname">University of California at Davis<br></br></span> <span class="orgdiv">Department of Statistics<br></br></span></div></div></div></div><hr></hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="idp6481472"></a></h2></div></div></div><p>
This explores how we can use the IdentifyDevice  to find out which 
primitive elements  that are drawn by R correspond to the elements in a plot.
We will use the <i xmlns="" class="rfunc"><a href="Help//heatmap.html" title="">heatmap()</a></i> function as our example as we have not yet
explored how that is constructed. 
The goal is to be able to post-process the SVG output from R
generated by a call to <i xmlns="" class="rfunc"><a href="Help//heatmap.html" title="">heatmap()</a></i> and to add tooltips
or some other interactive  capabilities.

</p><p>
We'll use the first example in the <i xmlns="" class="rfunc"><a href="Help//heatmap.html" title="">heatmap()</a></i> help page:
</p><pre xmlns="" class="scode" title="R plot">
x  = as.matrix(mtcars)
rc = rainbow(nrow(x), start=0, end=.3)
cc = rainbow(ncol(x), start=0, end=.3)

hv = heatmap(x, col = cm.colors(256), scale="column",
               RowSideColors = rc, ColSideColors = cc, margins=c(5,10),
              xlab = "specification variables", ylab= "Car Models",
              main = "heatmap(Mtcars data, ..., scale = \"column\")")
</pre>
<p xmlns=""></p>
<p><img xmlns="" src="heat.png">
Note that there is a lot in this plot.
We can see the main data area is made up of polygons.
We have to other sequences of polygons on the left and top sides.
And then we have two dendograms adjacent to these. 
Finally we have observations and variable labels on the right and bottom sides 
and finally we have x and y labels and a title.
</p><p>
Next we use our IdentifyDevice.
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6486192"><div><pre class="rcode" title="R code">
library(RGraphicsDevice)
source("device.R")
dev = metaDev(keepCalls = TRUE)
hv = heatmap(x, col = cm.colors(256), scale="column",
               RowSideColors = rc, ColSideColors = cc, margins=c(5,10),
              xlab = "specification variables", ylab= "Car Models",
              main = "heatmap(Mtcars data, ..., scale = \"column\")")
dev.off()
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
We can now access  the system calls:
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6486928"><div><pre class="rcode" title="R code">
info = dev$info()
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
We can look at the primitive operations via the 
<i xmlns="" class="rfunc"><a href="Help//names.html" title="">names()</a></i>  on the <b xmlns="" class="$" title="">info</b> list:
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6488080"><div><pre class="rcode" title="R code">
table(names(info))
<pre class="routput">
line rect text 
 164  395   46 
</pre>
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
We see that there are 395 calls to the "rect" (rectangle) primitive.
We have 32 observations in our data set and 11 variables.
This makes 352 rectangles for the main region.  
We also have a rectangle for each variable and each observation
in the sequence of rectangles on the sides of the plot.
This makes a total of 395 and so we have accounted for all of the rectangles.
</p><p>
The next thing we want to do is determine the order in which the
rectangles were drawn. We need to find the 352 data rectangles,
and then those in the horizontal strip, and finally those in the vertical 
strip. Let's get the rect elements:
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6489872"><div><pre class="rcode" title="R code">
rects = info[names(info) == "rect"]
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
Before we continue, let's also read the SVG document containing the generated plot:
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6490256"><div><pre class="rcode" title="R code">
library(XML)
doc = xmlParse("heat.svg")
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
We can then try to associate the primitive operations and the
graphical elements in the SVG document.
</p><p>
Within the SVG document, we are looking for
<code xmlns="" class="xmlTag">&lt;path&gt;</code> and <code xmlns="" class="xmlTag">&lt;g&gt;</code>
elements. We don't necessarily want all of them
as the cairo engine defines some
<code xmlns="" class="xmlTag">&lt;path&gt;</code> and <code xmlns="" class="xmlTag">&lt;g&gt;</code> elements
for use later on in the document. It does this for text, for instance.
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6492752"><div><pre class="rcode" title="R code">
gels = getNodeSet(doc, "//x:path|//x:g", "x")
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
Another way to think about this is that we want the top-level
<code xmlns="" class="xmlTag">&lt;g&gt;</code> node and this will skip the
<code xmlns="" class="xmlTag">&lt;defs&gt;</code> element.
So we can use
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6493904"><div><pre class="rcode" title="R code">
g = xmlRoot(doc)[["g"]]
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
Now we can find the <code xmlns="" class="xmlTag">&lt;path&gt;</code> and <code xmlns="" class="xmlTag">&lt;g&gt;</code>
elements within this sub-tree
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6495056"><div><pre class="rcode" title="R code">
gels = getNodeSet(g, ".//x:path|.//x:g", "x")
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
We end up with 612 nodes.
This is 7 more than in <b xmlns="" class="$" title="">info</b>.
Can we identify these 7 and so  establish the
connection between the primitives and the SVG elements?
</p><p>
Some of these <code xmlns="" class="xmlTag">&lt;g&gt;</code> elements are just acting as a container
or group (hence the name <code xmlns="" class="xmlTag">&lt;g&gt;</code>).
What we want is the collection of all <code xmlns="" class="xmlTag">&lt;path&gt;</code> nodes
and also all <code xmlns="" class="xmlTag">&lt;g&gt;</code> nodes which do not have
<code xmlns="" class="xmlTag">&lt;path&gt;</code> children. We can get these with
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6498240"><div><pre class="rcode" title="R code">
gels  = getNodeSet(g, ".//x:path | .//x:g[not(child::x:path)]", "x")
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
Here we end up with 607 nodes. 
So we still have 2 too many.
</p><p>
We need to eliminate the <code xmlns="" class="xmlTag">&lt;g&gt;</code> nodes that also have
<code xmlns="" class="xmlTag">&lt;g&gt;</code> nodes as children:
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6499856"><div><pre class="rcode" title="R code">
gels  = getNodeSet(g, ".//x:path | .//x:g[not(child::x:g) and not(child::x:path)]", "x")
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
And now we have a match for the number of nodes and graphical primitive operations in
<b xmlns="" class="$" title="">info</b>.
We do know is that they are in the same order.
However, we have to figure out how these relate to the visual elements in
our display.
</p><p>
It turns out that <i xmlns="" class="rfunc"><a href="Help//heatmap.html" title="">heatmap()</a></i> first
draws the vertical strip of polygons on the left side of the plot,
i.e. corresponding to the observations. So there are 32 of these.
The function then draws
the strip for the variables at the top of the plot.
There are 11 of these.
How do we know this? We can explore the SVG file manually
and exclude pieces and view the resulting document to see what is missing.
However, another approach is to return to our top-most
<code xmlns="" class="xmlTag">&lt;g&gt;</code> node and look at its children:
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6502544"><div><pre class="rcode" title="R code">
xmlSApply(g, xmlSize)
<pre class="routput">
rect    g    g    g    g    g    g    g 
   0   32   11  352   45  124   40    1 
</pre>
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
We see the rectangle (which we didn't draw, but libcairo did)
and then we see the next 395 elements are accounted for in the
first three <code xmlns="" class="xmlTag">&lt;g&gt;</code> nodes.
So this tells us also that the rectangles for each combination
of variable and observation are in the 352 elements in the third <code xmlns="" class="xmlTag">&lt;g&gt;</code>
node.
</p><p>
What is the order in which they are drawn?
Again, we can experiment manually. We can change the color on the first two <code xmlns="" class="xmlTag">&lt;path&gt;</code> elements in
this third <code xmlns="" class="xmlTag">&lt;g&gt;</code> node and make them, say, red.
When we reload the SVG document, we see that these are in the bottom left corner
and are vertically aligned, so  being drawn for each observation for a given variable.
If we change the 33rd <code xmlns="" class="xmlTag">&lt;path&gt;</code> element in this group, we will see
the next column.
</p><p>
An alternative approach  to manually modifying the SVG document is to look
at the coordinates of the path. 
We can compute each node's <i xmlns=""><a href="Help/SVGPath-class.html">SVGPath</a></i> with
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6507264"><div><pre class="rcode" title="R code">
library(SVGAnnotation)
p = lapply(gels[44:76], as, "SVGPath")
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
Then we can look at the first two and the 
last two to see where they are located.
</p><p>
We now have enough information to put tooltips on the
rectangles in the heatmap.  For example, let's create the 
text for the tips as
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6508336"><div><pre class="rcode" title="R code">
tmp = expand.grid(a = colnames(mtcars), b = rownames(mtcars), stringsAsFactors = FALSE)
tips = sprintf("%s, %s %f", tmp$a, tmp$b, c(t(x)))
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
Now we can add them with
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6508864"><div><pre class="rcode" title="R code">
addToolTips(gels[44:395], tips)
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
Now let's save the SVG document to a new file:
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6509312"><div><pre class="rcode" title="R code">
saveXML(doc, "heatTips.svg")
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>

</p><p>
The rectangles in the two strips on the sides of the plot
can be handled very similarly as
we know their nodes - <code xmlns="" class="Sexpression">gels[1:32]</code>
and <code xmlns="" class="Sexpression">gels[33:43]</code>.
</p></div><div class="section" title="Finding the Text"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="idp6511232"></a>Finding the Text</h2></div></div></div><p>
Let's see if we can find the SVG element corresponding to the title.
If we assume that the <i xmlns="" class="rfunc"><a href="Help//heatmap.html" title="">heatmap()</a></i> function
placed the title there with a call to the <i xmlns="" class="rfunc"><a href="Help//title.html" title="">title()</a></i>
function, we can search for that in the list of primitive calls, i.e. <b xmlns="" class="$" title="">info</b>:
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6513520"><div><pre class="rcode" title="R code">
which(sapply(info, function(x) any("title" == x)))
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
This gives us one element - number 605, i.e. the last.
</p><p>
Let's find the labels on the two axes.
We can see if the <i xmlns="" class="rfunc"><a href="Help//mtext.html" title="">mtext()</a></i> function was used to create these.
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6514864"><div><pre class="rcode" title="R code">
which(sapply(info, function(x) "mtext" %in% x))
<pre class="routput">
text text 
 407  440 
</pre>
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
So we now know which nodes correspond to these strings.
Which is which?  Again, we can look at the path
or alternatively we can look at the calls
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6515856"><div><pre class="rcode" title="R code">
dev$calls()[[407]]
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
We see the variable <b xmlns="" class="$" title="">xlab</b>.
We can even find the value of the string
from the first call
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6516688"><div><pre class="rcode" title="R code">
k = dev$calls()[[407]]
k[[1]]$xlab
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
Of course, there are alternative ways to get.
It is probably best to store the strings 
within the text graphics primitive in our IdentifyDevice.
</p><p>
What if we wanted to put tooltips or hyperlinks on
the strings within the labels, i.e. the row names and column names.
Let's examine all the text primitives but omit
the ones we already know correspond to the title
and the axes labels:
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6517856"><div><pre class="rcode" title="R code">
txt = info[-c(407, 440, 605)]
txt = txt[names(txt) == "text"]
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
This  gives us 43 nodes corresponding to the 11 + 32 names.
Now we can look at how they were called:
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6518416"><div><pre class="rcode" title="R code">
txt
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
We see that these are all generated from calls to <i xmlns="" class="rfunc"><a href="Help//axis.html" title="">axis()</a></i>
</p><p>
Since we want the SVG nodes corresponding to these, we can do the calculations
slightly differently.
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6519744"><div><pre class="rcode" title="R code">
i = 1:length(gels)
i = i[ !(i %in% c(407, 440, 605)) &amp; names(info) == "text"]
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
Then we get the nodes with
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6520304"><div><pre class="rcode" title="R code">
gels[i]
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
</p></div><div class="section" title="Putting It All Together"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="idp6520944"></a>Putting It All Together</h2></div></div></div><p>
Let's try to consolidate what we have learned into a function
</p><pre xmlns="" class="rfunction">
getSVGHeatmap =
function(doc)
{
  if(is.character(doc))
    doc = xmlParse(doc)

  g = xmlRoot(doc)[["g"]]

  nr = xmlSize(g[[3]])
  nc = xmlSize(g[[2]])

  strings = g[[5]]

  structure(list(dataRectangles = xmlChildren(g[[4]]),
                 verticalStrip =  xmlChildren(g[[2]]),
                 horizontalStrip = xmlChildren(g[[3]]),
                 xText = strings[nc],
                 yText = strings[seq(nc + 2, length = xmlSize(g[[3]]))],
                 title = if(xmlSize(g) &gt; 7) g[[xmlSize(g)]][[1]] else NULL,
                 axesLabels = list(x = strings[[nc + 1]], y = strings[[ length(strings) ]] ),
                 doc = doc),
             class = "SVGHeatmap")
}
</pre>
<p><br xmlns="">
This is not robust.
If any of the axes labels are suppressed, then there is an issue.
Similarly, if the dendograms are suppressed.
</p><p>
We can call this as
</p><div xmlns="" class="codeToggle"><div class="unhidden" id="idp6523840"><div><pre class="rcode" title="R code">
h = getSVGHeatmap("heat.svg")
</pre></div></div></div>
<div xmlns="" class="clearFloat"></div>
<p>
and then we can use
<i xmlns="" class="rfunc"><a href="Help//addToolTips.html" title="">addToolTips()</a></i>, etc.
to annotate the nodes.
Then we can <i xmlns="" class="rfunc"><a href="Help//saveXML.html" title="">saveXML()</a></i>
the document back to a file and view it.
</p><p>
Note that the xlink:title issue is present for the tooltips.
(See the <a class="ulink" href="http://www.omegahat.org/SVGAnnotation/FAQ.html" target="_top">http://www.omegahat.org/SVGAnnotation/FAQ.html</a>)

</p></div></div></body></html>
